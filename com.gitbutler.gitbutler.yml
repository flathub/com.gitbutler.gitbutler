id: com.gitbutler.gitbutler
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: gitbutler-tauri
rename-desktop-file: GitButler.desktop
rename-icon: gitbutler-tauri

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=gpg-agent
  - --socket=ssh-auth
  - --filesystem=host
  - --filesystem=xdg-run/gvfsd
  - --own-name=com.gitbutler.app
  - --talk-name=org.freedesktop.secrets

modules:
  - name: git
    cleanup:
      - /share
    make-args:
      - NO_PERL=1
      - NO_TCLTK=1
    make-install-args:
      - INSTALL_SYMLINKS=1
      - NO_PERL=1
      - NO_TCLTK=1
    sources:
      - type: archive
        url: https://www.kernel.org/pub/software/scm/git/git-2.53.0.tar.gz
        sha256: 429dc0f5fe5f14109930cdbbb588c5d6ef5b8528910f0d738040744bebdc6275
        x-checker-data:
          type: anitya
          project-id: 5350
          url-template: https://www.kernel.org/pub/software/scm/git/git-$version.tar.gz

  - name: gitbutler
    buildsystem: simple
    build-commands:
      - ar x GitButler.deb
      - tar xf data.tar.gz
      - mv usr/bin/* /app/bin
      - ln -s gitbutler-tauri /app/bin/but
      - mv usr/share/* /app/share
    sources:
      - type: file
        only-arches: [x86_64]
        url: https://releases.gitbutler.com/releases/release/0.19.3-2869/linux/x86_64/GitButler_0.19.3_amd64.deb
        sha256: 2bb7791cee5d9bf3746b6af94da261fa5134c2bc22f86cc33deafe9ff60eb4bd
        dest-filename: GitButler.deb
        x-checker-data:
          type: json
          url: https://app.gitbutler.com/api/downloads?channel=release
          version-query: .[0].version
          url-query: .[0].builds[].url | select(endswith("amd64.deb"))
      - type: file
        only-arches: [aarch64]
        dest-filename: GitButler.deb
        url: https://releases.gitbutler.com/releases/release/0.19.3-2869/linux/aarch64/GitButler_0.19.3_arm64.deb
        sha256: 9b01402c2b65b70cfd4aa37c32b3ca3131231e2c9314a888f24178eec5e1c8c0
        x-checker-data:
          type: json
          url: https://app.gitbutler.com/api/downloads?channel=release
          version-query: .[0].version
          url-query: .[0].builds[].url | select(endswith("arm64.deb"))
