id: com.gitbutler.gitbutler
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: gitbutler-tauri
rename-desktop-file: GitButler.desktop
rename-icon: gitbutler-tauri

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=gpg-agent
  - --socket=ssh-auth
  - --filesystem=host
  - --filesystem=xdg-run/gvfsd
  - --own-name=com.gitbutler.app
  - --talk-name=org.freedesktop.secrets

modules:
  - name: git
    cleanup:
      - /share
    make-args:
      - NO_PERL=1
      - NO_TCLTK=1
    make-install-args:
      - INSTALL_SYMLINKS=1
      - NO_PERL=1
      - NO_TCLTK=1
    sources:
      - type: archive
        url: https://www.kernel.org/pub/software/scm/git/git-2.52.0.tar.gz
        sha256: 6880cb1e737e26f81cf7db9957ab2b5bb2aa1490d87619480b860816e0c10c32
        x-checker-data:
          type: anitya
          project-id: 5350
          url-template: https://www.kernel.org/pub/software/scm/git/git-$version.tar.gz

  - name: gitbutler
    buildsystem: simple
    build-commands:
      - ar x GitButler.deb
      - tar xf data.tar.gz
      - mv usr/bin/* /app/bin
      - ln -s gitbutler-tauri /app/bin/but
      - mv usr/share/* /app/share
    sources:
      - type: file
        only-arches: [x86_64]
        url: https://releases.gitbutler.com/releases/release/0.18.6-2781/linux/x86_64/GitButler_0.18.6_amd64.deb
        sha256: f5d1f34d408652b18c54320eb71ee53f102349516435d0ea16fbde972b4abe87
        dest-filename: GitButler.deb
        x-checker-data:
          type: json
          url: https://app.gitbutler.com/api/downloads?channel=release
          version-query: .[0].version
          url-query: .[0].builds[].url | select(endswith("amd64.deb"))
      - type: file
        only-arches: [aarch64]
        dest-filename: GitButler.deb
        url: https://releases.gitbutler.com/releases/release/0.18.6-2781/linux/aarch64/GitButler_0.18.6_arm64.deb
        sha256: 558111addcd29714d20d4d39b0e2357de6499bdd2a8d69f96e5885d7c6cf1fd5
        x-checker-data:
          type: json
          url: https://app.gitbutler.com/api/downloads?channel=release
          version-query: .[0].version
          url-query: .[0].builds[].url | select(endswith("arm64.deb"))
